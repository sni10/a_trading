from __future__ import annotations

"""–¢–µ—Å—Ç—ã –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.

–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–µ –∫–ª—é—á–µ–≤—ã–µ –≤–µ—â–∏:

* ``setup_logging`` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–π –ª–æ–≥–≥–µ—Ä —Ç–∞–∫, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ñ–∞–π–ª —Å –Ω—É–∂–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏;
* ``log_stage`` –ø–∏—à–µ—Ç —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å emoji –∏ stage,
  –∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å timestamp –≤ —Ñ–æ—Ä–º–∞—Ç–µ
  ``YYYY-MM-DD HH:MM:SS,mmm - root - INFO -``.

–¢–µ—Å—Ç –ø—Ä–µ–¥–µ–ª—å–Ω–æ —É–ø—Ä–æ—â—ë–Ω –∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è,
—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–∫–∞—Ö wording.
"""

import logging
from pathlib import Path

from src.infrastructure.logging.logging_setup import setup_logging, log_stage


def test_log_stage_format_includes_milliseconds(tmp_path: Path) -> None:
    """log_stage –ø–∏—à–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–∞–π–ª —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏ –∏ –Ω—É–∂–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º.

    –§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–ª–∏–∑–æ–∫ –∫ –±–æ–µ–≤—ã–º –ª–æ–≥–∞–º –≤–∏–¥–∞::

        2025-08-14 11:43:29,142 - __main__ - INFO - ...

    –í –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ –∏–º—è –ª–æ–≥–≥–µ—Ä–∞ ‚Äî ``root``, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏ —Ñ–æ—Ä–º–∞—Ç
    –≤—Ä–µ–º–µ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
    """

    log_file = tmp_path / "test_prototype.log"

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å
    # —Ä–µ–∞–ª—å–Ω—ã–π prototype.log.
    setup_logging(str(log_file))

    # –ü–∏—à–µ–º –æ–¥–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ log_stage.
    log_stage("BOOT", "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", foo="bar")

    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ö–µ–Ω–¥–ª–µ—Ä —Å–±—Ä–æ—Å–∏–ª –±—É—Ñ–µ—Ä –≤ —Ñ–∞–π–ª.
    logging.shutdown()

    content = log_file.read_text(encoding="utf-8").strip().splitlines()
    assert content, "–û–∂–∏–¥–∞–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –ª–æ–≥–æ–≤"

    line = content[0]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π –ø—Ä–µ—Ñ–∏–∫—Å: –¥–∞—Ç–∞ + –≤—Ä–µ–º—è —Å –∑–∞–ø—è—Ç–æ–π –∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏,
    # –¥–∞–ª–µ–µ `` - root - INFO - ``.
    # –ü—Ä–∏–º–µ—Ä –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —à–∞–±–ª–æ–Ω–∞:
    # 2025-11-27 23:37:01,123 - root - INFO - üöÄ [BOOT] ...
    assert " - root - INFO - " in line

    prefix, _msg = line.split(" - root - INFO - ", 1)

    # –î–ª–∏–Ω–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ ``YYYY-MM-DD HH:MM:SS,mmm`` –≤—Å–µ–≥–¥–∞ 23 —Å–∏–º–≤–æ–ª–∞.
    assert len(prefix) == 23
    date_part, time_part = prefix.split(" ")

    # –ü—Ä–æ—Å—Ç–µ–π—à–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞.
    assert date_part.count("-") == 2
    assert "," in time_part
    hhmmss, msec = time_part.split(",")
    assert hhmmss.count(":") == 2
    assert len(msec) == 3
